#!/bin/bash
# ==============================================
# Virtual Machine Hypervisor Switcher (v1.0)
# Author: jammyjunior
# Github: https://github.com/jammyjunior/Switch-VM-Script
# ==============================================

# --- Colors ---
RED="\e[31m"; GREEN="\e[32m"; YELLOW="\e[33m"; CYAN="\e[36m"; RESET="\e[0m"

# --- Helper: check if module is loaded ---
is_loaded() {
  lsmod | grep -q "^$1"
}

# --- Status Check ---
check_status() {
  echo -e "${CYAN}Checking current virtualization status...${RESET}"
  if is_loaded vboxdrv || is_loaded vboxnetflt || is_loaded vboxnetadp; then
    echo -e "üß± VirtualBox modules are ${GREEN}active${RESET}."
  elif is_loaded kvm_intel || is_loaded kvm_amd; then
    echo -e "üöÄ QEMU/KVM modules are ${GREEN}active${RESET}."
  else
    echo -e "${YELLOW}‚ö†Ô∏è  No virtualization modules currently active.${RESET}"
  fi
  echo ""
}

# --- Stop VirtualBox ---
stop_virtualbox() {
  echo -e "${YELLOW}Stopping VirtualBox modules...${RESET}"
  sudo systemctl stop vboxdrv.service 2>/dev/null
  sudo modprobe -r vboxnetadp vboxnetflt vboxpci vboxdrv 2>/dev/null
  sudo rm -f /dev/vboxdrv /dev/vboxnetctl 2>/dev/null
  echo -e "${GREEN}VirtualBox modules unloaded.${RESET}"
}

# --- Stop QEMU/libvirt ---
stop_qemu() {
  echo -e "${YELLOW}Stopping libvirt/QEMU service...${RESET}"
  sudo systemctl stop libvirtd 2>/dev/null
  sudo modprobe -r kvm_intel kvm_amd kvm 2>/dev/null
  echo -e "${GREEN}KVM modules unloaded.${RESET}"
}

# --- Start VirtualBox ---
start_virtualbox() {
  echo -e "${CYAN}Switching to VirtualBox...${RESET}"
  stop_qemu
  echo -e "${YELLOW}Loading VirtualBox kernel modules...${RESET}"
  sudo modprobe vboxdrv && sudo modprobe vboxnetflt && sudo modprobe vboxnetadp
  if is_loaded vboxdrv; then
    echo -e "${GREEN}‚úÖ VirtualBox is ready to use.${RESET}"
  else
    echo -e "${RED}‚ùå Failed to load VirtualBox modules. Try rebooting.${RESET}"
  fi
}

# --- Start QEMU/KVM ---
start_qemu() {
  echo -e "${CYAN}Switching to QEMU/KVM...${RESET}"
  stop_virtualbox
  echo -e "${YELLOW}Starting libvirt daemon and KVM modules...${RESET}"
  sudo modprobe kvm
  if grep -q "Intel" /proc/cpuinfo; then
    sudo modprobe kvm_intel
  elif grep -q "AMD" /proc/cpuinfo; then
    sudo modprobe kvm_amd
  fi
  sudo systemctl start libvirtd
  if is_loaded kvm_intel || is_loaded kvm_amd; then
    echo -e "${GREEN}‚úÖ QEMU/KVM is ready to use.${RESET}"
  else
    echo -e "${RED}‚ùå Failed to load KVM modules. Check BIOS virtualization.${RESET}"
  fi
}

# --- Stop All ---
stop_all() {
  echo -e "${YELLOW}Stopping all virtualization systems...${RESET}"
  stop_virtualbox
  stop_qemu
  echo -e "${GREEN}‚úÖ All virtualization modules stopped.${RESET}"
}

# --- Menu ---
clear
check_status
echo -e "${CYAN}Which virtualization platform do you want to use?${RESET}"
echo "1) QEMU/KVM"
echo "2) VirtualBox"
echo "3) None (stop all)"
echo ""
read -rp "üëâ Enter choice [1-3]: " choice

case "$choice" in
  1) start_qemu ;;
  2) start_virtualbox ;;
  3)
    read -rp "Are you sure you want to stop all VMs? (y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      stop_all
    else
      echo -e "${CYAN}‚ùé Operation cancelled.${RESET}"
    fi
    ;;
  *)
    echo -e "${RED}Invalid choice. Exiting...${RESET}"
    exit 1
    ;;
esac

echo -e "\n${CYAN}Done.${RESET}"
